<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - E-Voting OSIS SMAN 23 Bandung</title>
    <link rel="icon" href="assets/logonirbhadikara.PNG" type="image/png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 3rem;
            height: 3rem;
            background: #1e40af;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
        }

        .logo-text p {
            font-size: 0.875rem;
            color: #64748b;
        }

        /* Navigation */
        .nav {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0;
        }

        .nav-tabs {
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-tab.active {
            color: #1e40af;
            border-bottom-color: #1e40af;
            background: #f8fafc;
        }

        .nav-tab:hover {
            color: #1e40af;
            background: #f8fafc;
        }

        /* Content */
        .content {
            padding: 2rem 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .card-description {
            color: #64748b;
            font-size: 0.875rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

        /* Stats Cards */
        .stat-card {
            text-align: center;
            padding: 2rem 1rem;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #1e40af;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-warning {
            background: #d97706;
            color: white;
        }

        .btn-warning:hover {
            background: #b45309;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 0.75rem;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #059669;
        }

        .alert-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        .alert-warning {
            background: #fffbeb;
            border: 1px solid #fed7aa;
            color: #d97706;
        }

        .alert-info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }

        /* Chart containers */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 1rem 0;
        }

        /* Action History */
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
        }

        .history-item.undone {
            opacity: 0.6;
            background: #f8fafc;
        }

        .history-action {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-time {
            font-size: 0.75rem;
            color: #64748b;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .spinner {
            width: 2rem;
            height: 2rem;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #1e40af;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .modal-content {
                width: 95%;
                margin: 1rem;
            }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">‚öôÔ∏è</div>
                    <div class="logo-text">
                        <h1>Admin Panel</h1>
                        <p>E-Voting OSIS SMAN 23 Bandung</p>
                    </div>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="window.open('main.html', '_blank')">
                        üó≥Ô∏è Lihat Website
                    </button>
                    <button class="btn btn-danger" onclick="logout()">
                        üö™ Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="nav-tab" onclick="switchTab('votes')">üó≥Ô∏è Kelola Suara</button>
                <button class="nav-tab" onclick="switchTab('candidates')">üë• Kelola Kandidat</button>
                <button class="nav-tab" onclick="switchTab('settings')">‚öôÔ∏è Pengaturan</button>
                <button class="nav-tab" onclick="switchTab('analytics')">üìà Analitik</button>
                <button class="nav-tab" onclick="switchTab('history')">üìù Riwayat</button>
            </div>
        </div>
    </nav>

    <!-- Content -->
    <main class="content">
        <div class="container">
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="grid grid-4" style="margin-bottom: 2rem;">
                    <div class="card">
                        <div class="stat-card">
                            <div class="stat-number" style="color: #1e40af;" id="total-votes-stat">-</div>
                            <div class="stat-label">Total Suara</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="stat-card">
                            <div class="stat-number" style="color: #059669;" id="participation-stat">-</div>
                            <div class="stat-label">Partisipasi</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="stat-card">
                            <div class="stat-number" style="color: #7c3aed;">3</div>
                            <div class="stat-label">Kandidat</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="stat-card">
                            <div class="stat-number" style="color: #dc2626;" id="remaining-stat">-</div>
                            <div class="stat-label">Belum Vote</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìä Grafik Suara per Kandidat</div>
                        </div>
                        <div class="card-content">
                            <div class="chart-container">
                                <canvas id="candidateChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìÖ Grafik Suara Harian</div>
                        </div>
                        <div class="card-content">
                            <div class="chart-container">
                                <canvas id="dailyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Votes Management Tab -->
            <div id="votes-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="card-title">üó≥Ô∏è Kelola Data Suara</div>
                                <div class="card-description">Tambah, edit, atau hapus data suara</div>
                            </div>
                            <button class="btn btn-primary" onclick="showAddVoteModal()">
                                ‚ûï Tambah Suara
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label class="form-label">Filter berdasarkan tanggal:</label>
                            <select id="date-filter" class="form-select" onchange="filterVotesByDate()">
                                <option value="">Semua Tanggal</option>
                            </select>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>NISN</th>
                                        <th>NIPD</th>
                                        <th>Kandidat</th>
                                        <th>Tanggal</th>
                                        <th>Waktu</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="votes-table-body">
                                    <tr>
                                        <td colspan="6" class="loading">
                                            <div class="spinner"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Candidates Management Tab -->
            <div id="candidates-tab" class="tab-content">
                <div class="grid grid-3" id="candidates-grid">
                     Candidates will be loaded here 
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">‚öôÔ∏è Pengaturan Sistem</div>
                        </div>
                        <div class="card-content">
                            <form id="settings-form">
                                <div class="form-group">
                                    <label class="form-label">Total Siswa</label>
                                    <input type="number" id="total-students" class="form-input" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Status Voting</label>
                                    <select id="voting-status" class="form-select">
                                        <option value="true">Buka</option>
                                        <option value="false">Tutup</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    üíæ Simpan Pengaturan
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üóëÔ∏è Reset Data</div>
                        </div>
                        <div class="card-content">
                            <div class="alert alert-warning">
                                <strong>‚ö†Ô∏è Peringatan:</strong> Aksi ini tidak dapat dibatalkan!
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <button class="btn btn-warning" onclick="resetVotes()">
                                    üó≥Ô∏è Reset Semua Suara
                                </button>
                                <button class="btn btn-danger" onclick="resetAll()">
                                    üí• Reset Semua Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content">
                <div class="grid grid-2" style="margin-bottom: 2rem;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìä Persentase Suara</div>
                        </div>
                        <div class="card-content">
                            <div class="chart-container">
                                <canvas id="pieChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">üìà Tren Voting</div>
                        </div>
                        <div class="card-content">
                            <div class="chart-container">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">üìÖ Detail per Tanggal</div>
                    </div>
                    <div class="card-content">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Total Suara</th>
                                        <th>Kandidat 01</th>
                                        <th>Kandidat 02</th>
                                        <th>Kandidat 03</th>
                                    </tr>
                                </thead>
                                <tbody id="daily-stats-table">
                                     Data will be loaded here 
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="card-title">üìù Riwayat Aksi</div>
                                <div class="card-description">Undo/Redo perubahan yang telah dilakukan</div>
                            </div>
                            <div>
                                <button class="btn btn-secondary" onclick="undoLastAction()" id="undo-btn" disabled>
                                    ‚Ü∂ Undo
                                </button>
                                <button class="btn btn-secondary" onclick="redoLastAction()" id="redo-btn" disabled>
                                    ‚Ü∑ Redo
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="history-list">
                            <!-- History items will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Vote Modal -->
    <div id="vote-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="vote-modal-title">Tambah Suara</div>
            </div>
            <div class="modal-body">
                <form id="vote-form">
                    <div class="form-group">
                        <label class="form-label">NISN</label>
                        <input type="text" id="vote-nisn" class="form-input" maxlength="10" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">NIPD</label>
                        <input type="text" id="vote-nipd" class="form-input" maxlength="12" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kandidat</label>
                        <select id="vote-candidate" class="form-select" required>
                            <option value="">Pilih Kandidat</option>
                            <option value="1">01 - Ahmad Rizki Pratama</option>
                            <option value="2">02 - Dinda Permata Sari</option>
                            <option value="3">03 - Muhammad Fajar Sidiq</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tanggal</label>
                        <input type="date" id="vote-date" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Waktu</label>
                        <input type="time" id="vote-time" class="form-input" step="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeVoteModal()">Batal</button>
                <button class="btn btn-primary" onclick="saveVote()">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Edit Candidate Modal -->
    <div id="candidate-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Kandidat</div>
            </div>
            <div class="modal-body">
                <form id="candidate-form">
                    <div class="form-group">
                        <label class="form-label">Nama</label>
                        <input type="text" id="candidate-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kelas</label>
                        <input type="text" id="candidate-class" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Visi</label>
                        <textarea id="candidate-visi" class="form-textarea" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Misi (pisahkan dengan enter)</label>
                        <textarea id="candidate-misi" class="form-textarea" rows="5" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Jargon</label>
                        <textarea id="candidate-program" class="form-textarea" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCandidateModal()">Batal</button>
                <button class="btn btn-primary" onclick="saveCandidate()">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
  apiKey: "AIzaSyBR_9ryRd7elw8I7QRgQnMdXip992i0exo",
  authDomain: "pemilulagi.firebaseapp.com",
  databaseURL: "https://pemilulagi-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "pemilulagi",
  storageBucket: "pemilulagi.firebasestorage.app",
  messagingSenderId: "7935828527",
  appId: "1:7935828527:web:829c422bf7fa50dd289cda"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global variables
        let currentTab = 'dashboard';
        let editingVote = null;
        let editingCandidate = null;
        let actionHistory = [];
        let historyIndex = -1;
        let charts = {};
        let totalStudents = 1200;
        let realTimeListeners = {};

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            // Check admin access (simple check - in production use proper authentication)
            const adminPassword = prompt('Masukkan password admin:');
            if (adminPassword !== 'admin123') {
                alert('Password salah!');
                window.location.href = 'main.html';
                return;
            }

            initializeRealTimeListeners();
            loadDashboard();
            loadSettings();
            loadHistory();
            
            // Set default date and time for vote form
            const now = new Date();
            document.getElementById('vote-date').value = now.toISOString().split('T')[0];
            document.getElementById('vote-time').value = now.toTimeString().split(' ')[0];
        });

        // Initialize real-time listeners
        function initializeRealTimeListeners() {
            // Listen to votes changes
            realTimeListeners.votes = database.ref('votes').on('value', (snapshot) => {
                updateStatistics(snapshot.val());
                if (currentTab === 'votes') {
                    loadVotes();
                }
                if (currentTab === 'dashboard' || currentTab === 'analytics') {
                    loadCharts();
                }
            });

            // Listen to candidates changes
            realTimeListeners.candidates = database.ref('candidates').on('value', (snapshot) => {
                if (currentTab === 'candidates') {
                    loadCandidates();
                }
                if (currentTab === 'dashboard' || currentTab === 'analytics') {
                    loadCharts();
                }
            });

            // Listen to settings changes
            realTimeListeners.settings = database.ref('settings').on('value', (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    totalStudents = settings.totalStudents || 1200;
                    updateStatistics();
                }
                if (currentTab === 'settings') {
                    loadSettings();
                }
            });
        }

        // Update statistics in real-time
        function updateStatistics(votesData = null) {
            if (!votesData) {
                database.ref('votes').once('value').then(snapshot => {
                    updateStatistics(snapshot.val());
                });
                return;
            }

            let totalVotes = 0;
            
            // Count total votes dari semua tanggal
            for (const date in votesData || {}) {
                if (votesData[date] && typeof votesData[date] === 'object') {
                    totalVotes += Object.keys(votesData[date]).length;
                }
            }
            
            const participationRate = ((totalVotes / totalStudents) * 100).toFixed(1);
            const remainingStudents = totalStudents - totalVotes;

            // Update UI
            const totalVotesEl = document.getElementById('total-votes-stat');
            const participationEl = document.getElementById('participation-stat');
            const remainingEl = document.getElementById('remaining-stat');

            if (totalVotesEl) totalVotesEl.textContent = totalVotes.toLocaleString();
            if (participationEl) participationEl.textContent = participationRate + '%';
            if (remainingEl) remainingEl.textContent = remainingStudents.toLocaleString();
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;

            // Load tab-specific data
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'votes':
                    loadVotes();
                    break;
                case 'candidates':
                    loadCandidates();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'history':
                    loadHistory();
                    break;
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                await loadCharts();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load charts
        async function loadCharts() {
            try {
                const [candidatesSnapshot, votesSnapshot] = await Promise.all([
                    database.ref('candidates').once('value'),
                    database.ref('votes').once('value')
                ]);
                
                const candidates = candidatesSnapshot.val() || {};
                const votesData = votesSnapshot.val() || {};

                // Candidate votes chart
                const candidateLabels = [];
                const candidateVotes = [];
                const candidateColors = ['#1e40af', '#059669', '#7c3aed'];

                Object.values(candidates).forEach((candidate, index) => {
                    candidateLabels.push(`${candidate.nomor} - ${candidate.nama}`);
                    candidateVotes.push(candidate.votes || 0);
                });

                // Destroy existing chart if exists
                if (charts.candidateChart) {
                    charts.candidateChart.destroy();
                }

                const candidateCtx = document.getElementById('candidateChart');
                if (candidateCtx) {
                    charts.candidateChart = new Chart(candidateCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: candidateLabels,
                            datasets: [{
                                label: 'Jumlah Suara',
                                data: candidateVotes,
                                backgroundColor: candidateColors,
                                borderColor: candidateColors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }

                // Daily votes chart
                const dailyData = {};
                for (const date in votesData) {
                    if (votesData[date] && typeof votesData[date] === 'object') {
                        dailyData[date] = Object.keys(votesData[date]).length;
                    }
                }

                const sortedDates = Object.keys(dailyData).sort();
                const dailyLabels = sortedDates.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit' });
                });
                const dailyVotes = sortedDates.map(date => dailyData[date]);

                if (charts.dailyChart) {
                    charts.dailyChart.destroy();
                }

                const dailyCtx = document.getElementById('dailyChart');
                if (dailyCtx) {
                    charts.dailyChart = new Chart(dailyCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: dailyLabels,
                            datasets: [{
                                label: 'Suara per Hari',
                                data: dailyVotes,
                                borderColor: '#1e40af',
                                backgroundColor: 'rgba(30, 64, 175, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }

                // Load analytics charts if on analytics tab
                if (currentTab === 'analytics') {
                    loadAnalyticsCharts(candidates, votesData);
                }

            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        // Load analytics charts
        function loadAnalyticsCharts(candidates, votesData) {
            try {
                // Pie chart
                const pieLabels = [];
                const pieData = [];
                const pieColors = ['#1e40af', '#059669', '#7c3aed'];

                Object.values(candidates).forEach((candidate, index) => {
                    pieLabels.push(`${candidate.nomor} - ${candidate.nama}`);
                    pieData.push(candidate.votes || 0);
                });

                if (charts.pieChart) {
                    charts.pieChart.destroy();
                }

                const pieCtx = document.getElementById('pieChart');
                if (pieCtx) {
                    charts.pieChart = new Chart(pieCtx.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: pieLabels,
                            datasets: [{
                                data: pieData,
                                backgroundColor: pieColors,
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }

                // Trend chart (cumulative votes over time)
                const dailyStats = {};
                for (const date in votesData) {
                    if (votesData[date] && typeof votesData[date] === 'object') {
                        dailyStats[date] = {};
                        for (const nisn in votesData[date]) {
                            const vote = votesData[date][nisn];
                            const candidateId = vote.candidateId;
                            dailyStats[date][candidateId] = (dailyStats[date][candidateId] || 0) + 1;
                        }
                    }
                }

                const sortedDates = Object.keys(dailyStats).sort();
                const trendDatasets = [];
                const candidateColors = ['#1e40af', '#059669', '#7c3aed'];

                Object.entries(candidates).forEach(([id, candidate], index) => {
                    let cumulativeVotes = 0;
                    const data = sortedDates.map(date => {
                        cumulativeVotes += dailyStats[date][id] || 0;
                        return cumulativeVotes;
                    });

                    trendDatasets.push({
                        label: `${candidate.nomor} - ${candidate.nama}`,
                        data: data,
                        borderColor: candidateColors[index],
                        backgroundColor: candidateColors[index] + '20',
                        tension: 0.4,
                        fill: false
                    });
                });

                if (charts.trendChart) {
                    charts.trendChart.destroy();
                }

                const trendCtx = document.getElementById('trendChart');
                if (trendCtx) {
                    charts.trendChart = new Chart(trendCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: sortedDates.map(date => {
                                const d = new Date(date);
                                return d.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit' });
                            }),
                            datasets: trendDatasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }

                // Daily stats table
                const tableBody = document.getElementById('daily-stats-table');
                if (tableBody) {
                    tableBody.innerHTML = '';

                    if (sortedDates.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #64748b;">Belum ada data</td></tr>';
                        return;
                    }

                    sortedDates.forEach(date => {
                        const stats = dailyStats[date];
                        const total = Object.values(stats).reduce((sum, count) => sum + count, 0);
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(date).toLocaleDateString('id-ID')}</td>
                            <td><strong>${total}</strong></td>
                            <td>${stats['1'] || 0}</td>
                            <td>${stats['2'] || 0}</td>
                            <td>${stats['3'] || 0}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                }

            } catch (error) {
                console.error('Error loading analytics charts:', error);
            }
        }

        // Load votes data
        async function loadVotes() {
            try {
                const [votesSnapshot, candidatesSnapshot] = await Promise.all([
                    database.ref('votes').once('value'),
                    database.ref('candidates').once('value')
                ]);
                
                const votesData = votesSnapshot.val() || {};
                const candidates = candidatesSnapshot.val() || {};

                const tbody = document.getElementById('votes-table-body');
                const dateFilter = document.getElementById('date-filter');
                
                if (!tbody || !dateFilter) return;
                
                // Clear existing data
                tbody.innerHTML = '';
                dateFilter.innerHTML = '<option value="">Semua Tanggal</option>';

                // Populate date filter
                const dates = Object.keys(votesData).sort().reverse();
                dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = new Date(date).toLocaleDateString('id-ID');
                    dateFilter.appendChild(option);
                });

                // Populate votes table
                let allVotes = [];
                for (const date in votesData) {
                    if (votesData[date] && typeof votesData[date] === 'object') {
                        for (const nisn in votesData[date]) {
                            const vote = votesData[date][nisn];
                            const candidate = candidates[vote.candidateId];
                            allVotes.push({
                                ...vote,
                                date: date,
                                candidateName: candidate ? `${candidate.nomor} - ${candidate.nama}` : 'Unknown'
                            });
                        }
                    }
                }

                // Sort by date and time (newest first)
                allVotes.sort((a, b) => {
                    const dateTimeA = new Date(a.date + ' ' + a.time);
                    const dateTimeB = new Date(b.date + ' ' + b.time);
                    return dateTimeB - dateTimeA;
                });

                if (allVotes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #64748b;">Belum ada data suara</td></tr>';
                    return;
                }

                allVotes.forEach(vote => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${vote.nisn}</td>
                        <td>${vote.nipd}</td>
                        <td>${vote.candidateName}</td>
                        <td>${new Date(vote.date).toLocaleDateString('id-ID')}</td>
                        <td>${vote.time}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editVote('${vote.date}', '${vote.nisn}')">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteVote('${vote.date}', '${vote.nisn}')">
                                üóëÔ∏è Hapus
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading votes:', error);
                const tbody = document.getElementById('votes-table-body');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc2626;">Error loading data</td></tr>';
                }
            }
        }

        // Filter votes by date
        function filterVotesByDate() {
            const selectedDate = document.getElementById('date-filter').value;
            const rows = document.querySelectorAll('#votes-table-body tr');
            
            rows.forEach(row => {
                if (!selectedDate) {
                    row.style.display = '';
                } else {
                    const dateCell = row.cells[3];
                    if (dateCell) {
                        const cellText = dateCell.textContent;
                        const dateParts = cellText.split('/');
                        if (dateParts.length === 3) {
                            const rowDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                            row.style.display = rowDate === selectedDate ? '' : 'none';
                        }
                    }
                }
            });
        }

        // Load candidates
        async function loadCandidates() {
            try {
                const candidatesSnapshot = await database.ref('candidates').once('value');
                const candidates = candidatesSnapshot.val() || {};
                
                const grid = document.getElementById('candidates-grid');
                if (!grid) return;
                
                grid.innerHTML = '';

                Object.entries(candidates).forEach(([id, candidate]) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-title">${candidate.nomor} - ${candidate.nama}</div>
                            <div class="card-description">${candidate.kelas} | ${candidate.votes || 0} suara</div>
                        </div>
                        <div class="card-content">
                            <div style="margin-bottom: 1rem;">
                                <strong>Visi:</strong>
                                <p style="font-size: 0.875rem; color: #64748b; margin-top: 0.25rem;">
                                    ${candidate.visi.substring(0, 100)}...
                                </p>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="editCandidate('${id}')">
                                ‚úèÔ∏è Edit Kandidat
                            </button>
                        </div>
                    `;
                    grid.appendChild(card);
                });

            } catch (error) {
                console.error('Error loading candidates:', error);
            }
        }

        // Load settings
        async function loadSettings() {
            try {
                const settingsSnapshot = await database.ref('settings').once('value');
                const settings = settingsSnapshot.val() || {};
                
                const totalStudentsEl = document.getElementById('total-students');
                const votingStatusEl = document.getElementById('voting-status');
                
                if (totalStudentsEl) totalStudentsEl.value = settings.totalStudents || 1200;
                if (votingStatusEl) votingStatusEl.value = settings.votingOpen !== false ? 'true' : 'false';

            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Load analytics
        async function loadAnalytics() {
            try {
                const [candidatesSnapshot, votesSnapshot] = await Promise.all([
                    database.ref('candidates').once('value'),
                    database.ref('votes').once('value')
                ]);
                
                const candidates = candidatesSnapshot.val() || {};
                const votesData = votesSnapshot.val() || {};

                loadAnalyticsCharts(candidates, votesData);

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Load history
        function loadHistory() {
            const historyList = document.getElementById('history-list');
            if (!historyList) return;
            
            historyList.innerHTML = '';

            if (actionHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #64748b;">Belum ada riwayat aksi</p>';
                return;
            }

            actionHistory.forEach((action, index) => {
                const item = document.createElement('div');
                item.className = `history-item ${index > historyIndex ? 'undone' : ''}`;
                item.innerHTML = `
                    <div class="history-action">
                        <span>${getActionIcon(action.type)}</span>
                        <span>${action.description}</span>
                    </div>
                    <div class="history-time">${action.timestamp}</div>
                `;
                historyList.appendChild(item);
            });

            // Update undo/redo buttons
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            
            if (undoBtn) undoBtn.disabled = historyIndex < 0;
            if (redoBtn) redoBtn.disabled = historyIndex >= actionHistory.length - 1;
        }

        // Get action icon
        function getActionIcon(type) {
            const icons = {
                'add_vote': '‚ûï',
                'edit_vote': '‚úèÔ∏è',
                'delete_vote': 'üóëÔ∏è',
                'edit_candidate': 'üë§',
                'edit_settings': '‚öôÔ∏è',
                'reset_votes': 'üîÑ',
                'reset_all': 'üí•'
            };
            return icons[type] || 'üìù';
        }

        // Add action to history
        function addToHistory(type, description, undoFunction, redoFunction) {
            // Remove any actions after current index
            actionHistory = actionHistory.slice(0, historyIndex + 1);
            
            // Add new action
            actionHistory.push({
                type: type,
                description: description,
                timestamp: new Date().toLocaleString('id-ID'),
                undo: undoFunction,
                redo: redoFunction
            });
            
            historyIndex = actionHistory.length - 1;
            
            // Keep only last 50 actions
            if (actionHistory.length > 50) {
                actionHistory = actionHistory.slice(-50);
                historyIndex = actionHistory.length - 1;
            }
            
            if (currentTab === 'history') {
                loadHistory();
            }
        }

        // Undo last action
        async function undoLastAction() {
            if (historyIndex >= 0) {
                const action = actionHistory[historyIndex];
                if (action.undo) {
                    await action.undo();
                    historyIndex--;
                    loadHistory();
                }
            }
        }

        // Redo last action
        async function redoLastAction() {
            if (historyIndex < actionHistory.length - 1) {
                historyIndex++;
                const action = actionHistory[historyIndex];
                if (action.redo) {
                    await action.redo();
                    loadHistory();
                }
            }
        }

        // Show add vote modal
        function showAddVoteModal() {
            editingVote = null;
            const modalTitle = document.getElementById('vote-modal-title');
            const voteForm = document.getElementById('vote-form');
            
            if (modalTitle) modalTitle.textContent = 'Tambah Suara';
            if (voteForm) voteForm.reset();
            
            // Set default values
            const now = new Date();
            const dateEl = document.getElementById('vote-date');
            const timeEl = document.getElementById('vote-time');
            
            if (dateEl) dateEl.value = now.toISOString().split('T')[0];
            if (timeEl) timeEl.value = now.toTimeString().split(' ')[0];
            
            document.getElementById('vote-modal').classList.remove('hidden');
        }

        // Edit vote
        async function editVote(date, nisn) {
            try {
                const voteSnapshot = await database.ref(`votes/${date}/${nisn}`).once('value');
                const vote = voteSnapshot.val();
                
                if (!vote) {
                    alert('Data suara tidak ditemukan!');
                    return;
                }

                editingVote = { date, nisn, originalData: vote };
                
                const modalTitle = document.getElementById('vote-modal-title');
                if (modalTitle) modalTitle.textContent = 'Edit Suara';
                
                const nisnEl = document.getElementById('vote-nisn');
                const nipdEl = document.getElementById('vote-nipd');
                const candidateEl = document.getElementById('vote-candidate');
                const dateEl = document.getElementById('vote-date');
                const timeEl = document.getElementById('vote-time');
                
                if (nisnEl) nisnEl.value = vote.nisn;
                if (nipdEl) nipdEl.value = vote.nipd;
                if (candidateEl) candidateEl.value = vote.candidateId;
                if (dateEl) dateEl.value = date;
                if (timeEl) timeEl.value = vote.time;
                
                document.getElementById('vote-modal').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading vote for edit:', error);
                alert('Error loading data!');
            }
        }

        // Save vote (add or edit)
        async function saveVote() {
            try {
                const nisn = document.getElementById('vote-nisn').value;
                const nipd = document.getElementById('vote-nipd').value;
                const candidateId = document.getElementById('vote-candidate').value;
                const date = document.getElementById('vote-date').value;
                const time = document.getElementById('vote-time').value;

                if (!nisn || !nipd || !candidateId || !date || !time) {
                    alert('Semua field harus diisi!');
                    return;
                }

                const voteData = {
                    nisn: nisn,
                    nipd: nipd,
                    candidateId: candidateId,
                    time: time,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                if (editingVote) {
                    // Edit existing vote
                    const oldData = editingVote.originalData;
                    
                    // Remove from old location if date or nisn changed
                    if (editingVote.date !== date || editingVote.nisn !== nisn) {
                        await database.ref(`votes/${editingVote.date}/${editingVote.nisn}`).remove();
                        
                        // Update old candidate count
                        await database.ref(`candidates/${oldData.candidateId}/votes`).transaction((votes) => {
                            return Math.max(0, (votes || 0) - 1);
                        });
                    }
                    
                    // Save to new location
                    await database.ref(`votes/${date}/${nisn}`).set(voteData);
                    
                    // Update candidate counts if candidate changed
                    if (oldData.candidateId !== candidateId) {
                        // Decrease old candidate (if not already decreased above)
                        if (editingVote.date === date && editingVote.nisn === nisn) {
                            await database.ref(`candidates/${oldData.candidateId}/votes`).transaction((votes) => {
                                return Math.max(0, (votes || 0) - 1);
                            });
                        }
                        
                        // Increase new candidate
                        await database.ref(`candidates/${candidateId}/votes`).transaction((votes) => {
                            return (votes || 0) + 1;
                        });
                    } else if (editingVote.date === date && editingVote.nisn === nisn) {
                        // Same candidate, same location - no count change needed
                    } else {
                        // Different location, same candidate - add count
                        await database.ref(`candidates/${candidateId}/votes`).transaction((votes) => {
                            return (votes || 0) + 1;
                        });
                    }

                    addToHistory('edit_vote', `Edit suara ${nisn}`, 
                        async () => {
                            // Undo: restore original data
                            await database.ref(`votes/${date}/${nisn}`).remove();
                            await database.ref(`votes/${editingVote.date}/${editingVote.nisn}`).set(oldData);
                            
                            // Restore candidate counts
                            await database.ref(`candidates/${candidateId}/votes`).transaction((votes) => {
                                return Math.max(0, (votes || 0) - 1);
                            });
                            await database.ref(`candidates/${oldData.candidateId}/votes`).transaction((votes) => {
                                return (votes || 0) + 1;
                            });
                        },
                        async () => {
                            // Redo: apply changes again
                            await database.ref(`votes/${editingVote.date}/${editingVote.nisn}`).remove();
                            await database.ref(`votes/${date}/${nisn}`).set(voteData);
                            
                            await database.ref(`candidates/${oldData.candidateId}/votes`).transaction((votes) => {
                                return Math.max(0, (votes || 0) - 1);
                            });
                            await database.ref(`candidates/${candidateId}/votes`).transaction((votes) => {
                                return (votes || 0) + 1;
                            });
                        }
                    );

                } else {
                    // Add new vote
                    await database.ref(`votes/${date}/${nisn}`).set(voteData);
                    
                    // Update candidate count
                    await database.ref(`candidates/${candidateId}/votes`).transaction((votes) => {
                        return (votes || 0) + 1;
                    });

                    addToHistory('add_vote', `Tambah suara ${nisn}`,
                        async () => {
                            // Undo: remove vote
                            await database.ref(`votes/${date}/${nisn}`).remove();
                            await database.ref(`candidates/${candidateId}/votes`).transaction((votes) => {
                                return Math.max(0, (votes || 0) - 1);
                            });
                        },
                        async () => {
                            // Redo: add vote back
                            await database.ref(`votes/${date}/${nisn}`).set(voteData);
                            await database.ref(`candidates/${candidateId}/votes`).transaction((votes) => {
                                return (votes || 0) + 1;
                            });
                        }
                    );
                }

                closeVoteModal();
                alert('Data suara berhasil disimpan!');

            } catch (error) {
                console.error('Error saving vote:', error);
                alert('Error menyimpan data!');
            }
        }

        // Delete vote
        async function deleteVote(date, nisn) {
            if (!confirm('Yakin ingin menghapus suara ini?')) {
                return;
            }

            try {
                const voteSnapshot = await database.ref(`votes/${date}/${nisn}`).once('value');
                const voteData = voteSnapshot.val();
                
                if (!voteData) {
                    alert('Data tidak ditemukan!');
                    return;
                }

                // Remove vote
                await database.ref(`votes/${date}/${nisn}`).remove();
                
                // Update candidate count
                await database.ref(`candidates/${voteData.candidateId}/votes`).transaction((votes) => {
                    return Math.max(0, (votes || 0) - 1);
                });

                addToHistory('delete_vote', `Hapus suara ${nisn}`,
                    async () => {
                        // Undo: restore vote
                        await database.ref(`votes/${date}/${nisn}`).set(voteData);
                        await database.ref(`candidates/${voteData.candidateId}/votes`).transaction((votes) => {
                            return (votes || 0) + 1;
                        });
                    },
                    async () => {
                        // Redo: delete again
                        await database.ref(`votes/${date}/${nisn}`).remove();
                        await database.ref(`candidates/${voteData.candidateId}/votes`).transaction((votes) => {
                            return Math.max(0, (votes || 0) - 1);
                        });
                    }
                );

                alert('Data suara berhasil dihapus!');

            } catch (error) {
                console.error('Error deleting vote:', error);
                alert('Error menghapus data!');
            }
        }

        // Close vote modal
        function closeVoteModal() {
            document.getElementById('vote-modal').classList.add('hidden');
            editingVote = null;
        }

        // Edit candidate
        async function editCandidate(candidateId) {
            try {
                const candidateSnapshot = await database.ref(`candidates/${candidateId}`).once('value');
                const candidate = candidateSnapshot.val();
                
                if (!candidate) {
                    alert('Data kandidat tidak ditemukan!');
                    return;
                }

                editingCandidate = { id: candidateId, originalData: candidate };
                
                const nameEl = document.getElementById('candidate-name');
                const classEl = document.getElementById('candidate-class');
                const visiEl = document.getElementById('candidate-visi');
                const misiEl = document.getElementById('candidate-misi');
                const programEl = document.getElementById('candidate-program');
                
                if (nameEl) nameEl.value = candidate.nama;
                if (classEl) classEl.value = candidate.kelas;
                if (visiEl) visiEl.value = candidate.visi;
                if (misiEl) misiEl.value = candidate.misi.join('\n');
                if (programEl) programEl.value = candidate.program;
                
                document.getElementById('candidate-modal').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading candidate for edit:', error);
                alert('Error loading data!');
            }
        }

        // Save candidate
        async function saveCandidate() {
            try {
                const nama = document.getElementById('candidate-name').value;
                const kelas = document.getElementById('candidate-class').value;
                const visi = document.getElementById('candidate-visi').value;
                const misi = document.getElementById('candidate-misi').value.split('\n').filter(m => m.trim());
                const program = document.getElementById('candidate-program').value;

                if (!nama || !kelas || !visi || misi.length === 0 || !program) {
                    alert('Semua field harus diisi!');
                    return;
                }

                const candidateData = {
                    ...editingCandidate.originalData,
                    nama: nama,
                    kelas: kelas,
                    visi: visi,
                    misi: misi,
                    program: program
                };

                await database.ref(`candidates/${editingCandidate.id}`).set(candidateData);

                addToHistory('edit_candidate', `Edit kandidat ${nama}`,
                    async () => {
                        // Undo: restore original data
                        await database.ref(`candidates/${editingCandidate.id}`).set(editingCandidate.originalData);
                    },
                    async () => {
                        // Redo: apply changes again
                        await database.ref(`candidates/${editingCandidate.id}`).set(candidateData);
                    }
                );

                closeCandidateModal();
                alert('Data kandidat berhasil disimpan!');

            } catch (error) {
                console.error('Error saving candidate:', error);
                alert('Error menyimpan data!');
            }
        }

        // Close candidate modal
        function closeCandidateModal() {
            document.getElementById('candidate-modal').classList.add('hidden');
            editingCandidate = null;
        }

        // Save settings
        document.getElementById('settings-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const totalStudentsEl = document.getElementById('total-students');
                const votingStatusEl = document.getElementById('voting-status');
                
                const totalStudentsValue = parseInt(totalStudentsEl.value);
                const votingOpen = votingStatusEl.value === 'true';

                const oldSettingsSnapshot = await database.ref('settings').once('value');
                const oldSettings = oldSettingsSnapshot.val() || {};

                const newSettings = {
                    totalStudents: totalStudentsValue,
                    votingOpen: votingOpen,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                };

                await database.ref('settings').set(newSettings);

                addToHistory('edit_settings', `Update pengaturan sistem`,
                    async () => {
                        // Undo: restore old settings
                        await database.ref('settings').set(oldSettings);
                    },
                    async () => {
                        // Redo: apply new settings
                        await database.ref('settings').set(newSettings);
                    }
                );

                alert('Pengaturan berhasil disimpan!');

            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error menyimpan pengaturan!');
            }
        });

        // Reset votes
        async function resetVotes() {
            if (!confirm('Yakin ingin menghapus SEMUA data suara? Aksi ini tidak dapat dibatalkan!')) {
                return;
            }

            try {
                // Backup current data
                const votesSnapshot = await database.ref('votes').once('value');
                const candidatesSnapshot = await database.ref('candidates').once('value');
                const backupVotes = votesSnapshot.val();
                const backupCandidates = candidatesSnapshot.val();

                // Reset votes
                await database.ref('votes').remove();
                
                // Reset candidate vote counts
                const candidates = candidatesSnapshot.val() || {};
                for (const id in candidates) {
                    await database.ref(`candidates/${id}/votes`).set(0);
                }

                addToHistory('reset_votes', `Reset semua data suara`,
                    async () => {
                        // Undo: restore all data
                        if (backupVotes) {
                            await database.ref('votes').set(backupVotes);
                        }
                        if (backupCandidates) {
                            await database.ref('candidates').set(backupCandidates);
                        }
                    },
                    async () => {
                        // Redo: reset again
                        await database.ref('votes').remove();
                        for (const id in candidates) {
                            await database.ref(`candidates/${id}/votes`).set(0);
                        }
                    }
                );

                alert('Semua data suara berhasil dihapus!');

            } catch (error) {
                console.error('Error resetting votes:', error);
                alert('Error menghapus data!');
            }
        }

        // Reset all data
        async function resetAll() {
            if (!confirm('Yakin ingin menghapus SEMUA data termasuk kandidat dan pengaturan? Aksi ini tidak dapat dibatalkan!')) {
                return;
            }

            if (!confirm('Konfirmasi sekali lagi: SEMUA DATA AKAN HILANG!')) {
                return;
            }

            try {
                // Backup all data
                const allDataSnapshot = await database.ref().once('value');
                const backupData = allDataSnapshot.val();

                // Reset everything
                await database.ref().remove();

                addToHistory('reset_all', `Reset semua data sistem`,
                    async () => {
                        // Undo: restore all data
                        if (backupData) {
                            await database.ref().set(backupData);
                        }
                    },
                    async () => {
                        // Redo: reset all again
                        await database.ref().remove();
                    }
                );

                alert('Semua data berhasil dihapus! Halaman akan dimuat ulang.');
                location.reload();

            } catch (error) {
                console.error('Error resetting all data:', error);
                alert('Error menghapus data!');
            }
        }

        // Logout
        function logout() {
            if (confirm('Yakin ingin logout?')) {
                // Remove real-time listeners
                for (const key in realTimeListeners) {
                    database.ref(key).off('value', realTimeListeners[key]);
                }
                window.location.href = 'main.html';
            }
        }

        // Close modals when clicking outside
        document.getElementById('vote-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeVoteModal();
            }
        });

        document.getElementById('candidate-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCandidateModal();
            }
        });

        // Input validation
        document.getElementById('vote-nisn').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
        });

        document.getElementById('vote-nipd').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 12);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            for (const key in realTimeListeners) {
                database.ref(key).off('value', realTimeListeners[key]);
            }
        });
    </script>
</body>
</html>
